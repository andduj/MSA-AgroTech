### Название задачи
Разработка MVP системы мониторинга скота для компании «АгроТех Х»

### Автор
Архитектурная команда

### Дата
2024

### Проблема и контекст
Компания «АгроТех Х» имеет 150 тепличных комплексов и занимается свиноводством. Существующий IT-ландшафт включает современные и устаревшие технологии. Компания внедрила мониторинг техники, но сейчас стоит задача повысить эффективность в сфере животноводства и автоматизировать процессы кормления, безопасности и мониторинга поголовья.

Существующие решения на рынке (PigVision, ALUS, PigTales) не подходят из-за законодательных ограничений или высокой стоимости. Требуется создать MVP с нуля, который в будущем может стать SaaS-решением.

### Функциональные требования

|№|Действующие лица или системы|Use Case|Описание|
|:-:|:-|:-|:-|
|1|Система видеоаналитики|Фиксация беспокойного поведения|Автоматическое обнаружение драк и беспокойства среди животных с оповещением оператора|
|2|Система видеоаналитики|Фиксация задавливания поросят|Обнаружение случаев задавливания поросят взрослыми особями|
|3|Система управления|Управление кормушками и поилками|Интеграция с оборудованием разных производителей для автоматического управления|
|4|Система видеоаналитики|Оценка состояния животных|Анализ внешнего вида и поведения для выявления болезней, гибели, беспокойства|
|5|IoT система|Мониторинг фильтрации воды|Отслеживание состояния систем фильтрации воды|
|6|Система подсчета|Пересчет поголовья|Автоматический подсчет количества животных|
|7|Система планирования|Прогнозирование расхода корма|Мониторинг запасов и прогнозирование потребности в корме|
|8|Система видеоаналитики|Поддержка множественных камер|Интеграция с камерами разных производителей для аналитики в реальном времени|
|9|Агентская система|Работа без интернета|Функционирование при отсутствии связи с локальными уведомлениями|
|10|Система безопасности|Аутентификация и авторизация|Разделение ролей с современными методами безопасности|
|11|API система|Интеграция с внешними системами|Предоставление API для мобильных и веб-приложений|

### Нефункциональные требования

|№|Требование|
|:-:|:-|
|1|Отказоустойчивость 99,95%|
|2|Расширяемость системы без изменения существующего функционала|
|3|Высокая производительность: оповещение за 5 секунд после обнаружения нештатной ситуации|
|4|Реакция видеоаналитики в реальном времени (миллисекунды)|
|5|Синхронизация между агентами и центральным сервером с задержкой до 10 минут|
|6|Работа в условиях нестабильного WiFi на фермах|
|7|Покрытие камерами всей площади без слепых зон|

### Решение (Task1: Архитектурные варианты)

#### Основное решение: Агентская архитектура

**Контекстная диаграмма основного решения:**

![Main context diagram](../Task1/context_diagram_main.png)

**Обоснование выбора технологий:**
1. Агентская архитектура — обеспечивает работу при отсутствии интернета и снижает зависимость от сетевой инфраструктуры
2. Интеграция с существующими системами — использование Kafka для событийной архитектуры и REST API для синхронного взаимодействия
3. Готовая нейросетевая модель — снижает время разработки и риски
4. MQTT/LoRaWAN — для IoT устройств, обеспечивает надежную передачу данных в условиях нестабильной связи
5. Web UI — для операторов ферм, обеспечивает простоту использования

#### Альтернативное решение: Edge-вычислительная архитектура

**Контекстная диаграмма альтернативного решения:**

![Alternative context diagram](../Task1/context_diagram_alternative.png)

**Обоснование альтернативного решения:**
1. Edge-вычислитель — более мощная локальная обработка данных
2. Локальная база данных — полное хранение данных на ферме
3. Batch-синхронизация — снижение нагрузки на сеть
4. Более сложная архитектура — требует больше ресурсов на ферме

### Альтернативы, риски и компромиссы (Task1)

**Основное решение (Агентская архитектура):**
- Преимущества: Простота развертывания, низкие требования к ресурсам, быстрая разработка MVP
- Недостатки: Ограниченная локальная обработка, зависимость от центрального сервера для сложной аналитики

**Альтернативное решение (Edge-вычислительная архитектура):**
- Преимущества: Мощная локальная обработка, независимость от центрального сервера, возможность сложной аналитики на месте
- Недостатки: Высокая стоимость развертывания, сложность обслуживания, избыточность для MVP

**Технические риски:**
1. Качество нейросетевой модели — готовые модели могут не подходить для специфических условий ферм
2. Проблемы с освещением — ночная съемка требует специального оборудования
3. Трекинг животных — сложность идентификации похожих особей
4. Нестабильный WiFi — требует резервных каналов связи

**Архитектурные риски:**
1. Масштабируемость — при росте количества ферм может потребоваться пересмотр архитектуры
2. Интеграция с существующими системами — сложность интеграции с устаревшими компонентами
3. Безопасность — риски при работе с персональными данными и критически важными системами

**Бизнес-риски:**
1. Стоимость развертывания — высокая стоимость оборудования для каждой фермы
2. Обучение персонала — необходимость обучения операторов работе с новой системой
3. Регулятивные требования — возможные изменения в законодательстве по работе с животными

**Компромиссы:**
1. Выбор основного решения — компромисс между функциональностью и стоимостью для MVP
2. Задержка синхронизации — компромисс между актуальностью данных и стабильностью работы
3. Использование готовой нейросети — компромисс между качеством и скоростью разработки

---

# Детализация архитектуры и развитие (Task2)

### Ограниченные контексты (Bounded Contexts)
Определены следующие ограниченные контексты для проектирования микросервисов:

| № | Контекст                | Описание |
|:-:|-------------------------|----------|
| 1 | Контекст мониторинга    | Сбор и анализ данных с камер, датчиков, видеоаналитика, тревоги |
| 2 | Контекст управления     | Управление кормушками, поилками, исполнительными устройствами |
| 3 | Контекст учёта и отчётности | Учёт поголовья, событий, формирование отчётов, интеграция с BI/ERP |
| 4 | Контекст интеграции     | Интеграция с внешними системами, шлюзами, очередями сообщений |
| 5 | Контекст безопасности   | Аутентификация, авторизация, управление ролями |

### Варианты архитектурных решений (диаграммы контейнеров)

#### Вариант 1: RabbitMQ как основная очередь сообщений
- Используется RabbitMQ для обмена сообщениями между сервисами и интеграции с IoT-устройствами (через MQTT).

![Контейнерная диаграмма RabbitMQ](container_diagram_rabbitmq.png)

#### Вариант 2: Kafka как основная очередь сообщений
- Используется Kafka для событийной интеграции между сервисами и потоковой обработки данных.

![Контейнерная диаграмма Kafka](container_diagram_kafka.png)

### Интеграции между сервисами и обоснование выбора технологий

#### Вариант 1 (RabbitMQ)
- **Преимущества:**
  - Возможность использовать MQTT для взаимодействия с IoT-устройствами
  - Распространённая технология, не требовательна к ресурсам
  - Поддаётся кластеризации
- **Ограничения:**
  - При высоких нагрузках может потребоваться переход на Kafka
  - Менее удобна для потоковой аналитики

#### Вариант 2 (Kafka)
- **Преимущества:**
  - Высокая производительность и масштабируемость
  - Поддержка потоковой обработки данных (stream processing)
  - Хорошо подходит для событийно-ориентированной архитектуры
- **Ограничения:**
  - Более сложная эксплуатация и настройка
  - Требует больше ресурсов
  - Не поддерживает MQTT "из коробки"

### Компромиссы и риски

| Вариант | Компромиссы | Риски |
|---------|-------------|-------|
| RabbitMQ | Простота и универсальность, но ограничение по масштабируемости и аналитике | Возможные задержки при больших объёмах данных, сложность миграции на Kafka |
| Kafka    | Масштабируемость и потоковая аналитика, но сложность эксплуатации и интеграции с IoT | Повышенные требования к инфраструктуре, сложность поддержки, отсутствие MQTT |


**Обоснование выбора единого стека C# (.NET):**
- Использование одного языка программирования для всех микросервисов существенно упрощает сопровождение, развитие и поддержку системы.
- Единый стек снижает требования к компетенциям команды, ускоряет обучение новых сотрудников, облегчает автоматизацию CI/CD, мониторинг и эксплуатацию.
- Применение разных языков и технологий в рамках одной системы приводит к усложнению инфраструктуры, увеличению затрат на поддержку, росту числа ошибок интеграции и снижению скорости внедрения изменений.
- Поэтому для данного проекта выбран единый стек C# (.NET) для всех микросервисов как наиболее рациональный и управляемый подход.

**Почему C# (.NET) — подходящий выбор для данной системы:**
- Современный .NET Core кроссплатформенный, поддерживает Linux и Windows, легко контейнеризуется (Docker, Kubernetes).
- Предоставляет хорошую поддержку микросервисной архитектуры: REST/gRPC, очереди сообщений (RabbitMQ, Kafka), работа с БД, интеграция с IoT (MQTT, AMQP).
- Имеет развитую экосистему библиотек и инструментов для корпоративных, промышленных и IoT-решений.
- Обеспечивает достаточную производительность и масштабируемость, зрелые средства мониторинга и автоматизации.
- Позволяет интегрироваться с BI/ERP и корпоративными системами.
- На рынке достаточно специалистов, платформа активно развивается и поддерживается сообществом.
- Позволяет реализовать все необходимые сервисы (мониторинг, управление, интеграция, безопасность, отчётность) в едином технологическом стеке.

**Архитектурное решение по хранению данных:**
- В соответствии с принципами микросервисной архитектуры, каждый сервис владеет своей собственной базой данных (или схемой). Это обеспечивает слабую связанность, независимость развертывания и масштабирования, а также изоляцию данных.
- Такой подход упрощает сопровождение, позволяет изменять схему данных и масштабировать сервисы независимо друг от друга, снижает риски конфликтов и ошибок интеграции.
- Для MVP допускается использование отдельных схем в одной СУБД, но для промышленной эксплуатации рекомендуется физическое разделение БД.

### Паттерны и способы взаимодействия между микросервисами

**Характер взаимодействия:**
- В системе используются оба паттерна: «точка-точка» (point-to-point) и «публикация-подписка» (pub/sub).
- 
  - **Точка-точка** применяется для команд и запросов, когда сообщение или команда адресованы конкретному сервису (например, команда управления устройством от сервиса управления к исполнительному устройству через очередь).
  - **Публикация-подписка** используется для событий, которые могут быть интересны нескольким сервисам (например, событие о тревоге публикуется сервисом мониторинга и может быть обработано сервисом учёта, интеграционным сервисом и др.).

**Способ взаимодействия:**
- 
  - **Синхронное взаимодействие** реализовано через REST/gRPC между API Gateway и микросервисами. Клиент получает ответ в рамках одного сетевого подключения. Применяется для операций, где важна немедленная реакция (например, запрос состояния, получение отчёта, управление пользователями).
  - **Асинхронное взаимодействие** реализовано через очереди сообщений (RabbitMQ или Kafka). Сервис-отправитель публикует событие или команду, а получатель обрабатывает её независимо, возможно с задержкой. Применяется для событий, команд управления устройствами, интеграции с IoT, уведомлений.

**Примеры для данной архитектуры:**
- Сервис мониторинга публикует событие тревоги в очередь (pub/sub), которое может быть обработано сервисом учёта и интеграционным сервисом.
- Сервис управления отправляет команду конкретному устройству через очередь (point-to-point).
- API Gateway вызывает сервис учёта по REST для получения отчёта (синхронно).
- IoT-устройства отправляют данные через MQTT (асинхронно) в очередь сообщений.

**Выбор конкретного паттерна и способа взаимодействия зависит от бизнес-логики и требований к скорости реакции, надёжности и масштабируемости.** 

## Выбор технологии очереди сообщений

Для MVP и пилотного внедрения системы мониторинга выбран RabbitMQ как основная очередь сообщений. Это решение обусловлено следующими причинами:
- RabbitMQ обеспечивает необходимую надёжность, простоту эксплуатации и интеграцию с IoT (через MQTT) для ограниченного количества ферм и агентов.
- Ожидаемая нагрузка на этапе MVP и начального масштабирования не превышает порог, при котором требуется использовать Kafka.
- RabbitMQ позволяет быстро развернуть и поддерживать систему, минимизируя инфраструктурные затраты.

**Переход на Kafka** может быть рассмотрен в будущем, если система будет масштабироваться до десятков тысяч сообщений в секунду, потребуется потоковая аналитика или появятся новые требования к отказоустойчивости и обработке больших объёмов данных.

**Итог:**
- Основная очередь сообщений: RabbitMQ
- Kafka не используется в текущей архитектуре, но может быть рассмотрена при существенном росте нагрузки. 

## SLA и требования к времени реакции
- Время реакции на критическую тревогу (Alarm): не более 5 секунд от момента возникновения события до оповещения оператора.
- Время доставки сообщения между сервисами RabbitMQ: не более 1 секунды для 99% сообщений.
- Время синхронизации между агентом и центральным сервером: не более 10 минут при восстановлении связи.

## Мониторинг и алертинг инфраструктуры
- Для RabbitMQ, БД и всех микросервисов настраивается мониторинг (Prometheus, Grafana, встроенные метрики RabbitMQ).
- Критерии алертов: переполнение очереди, задержки доставки сообщений, отказ сервисов, превышение времени ответа API, ошибки подключения к БД.
- Используется dead-letter queue для сообщений, которые не удалось обработать после нескольких попыток.

## Обработка ошибок и отказоустойчивость
- Все сервисы реализуют обработку ошибок с ретраями (повторными попытками) и логированием неудачных операций.
- Для критических ошибок используется dead-letter queue и уведомление операторов.
- При отказе RabbitMQ или БД сервисы переходят в режим деградации (ограниченная функциональность, локальное хранение событий до восстановления связи).

## Безопасность
- Все взаимодействия между сервисами и очередями RabbitMQ защищены TLS.
- Аутентификация и авторизация пользователей и сервисов реализована через отдельный сервис безопасности (JWT, OAuth2).
- Данные в БД шифруются на уровне хранения (at rest) и передачи (in transit).
- IoT-устройства аутентифицируются по сертификатам или токенам.

## Версионирование API
- Внешние и внутренние API версионируются (например, /api/v1/...), чтобы обеспечить обратную совместимость при развитии системы.
- Изменения в API документируются и тестируются на совместимость.

## Сценарии деградации и отказоустойчивость
- При потере связи между агентом и центральным сервером события и тревоги накапливаются локально и синхронизируются при восстановлении связи.
- При переполнении очереди RabbitMQ или отказе БД сервисы переходят в режим ограниченной функциональности, уведомляют операторов и сохраняют данные локально.
- Для всех критических компонентов предусмотрены резервные копии и автоматическое восстановление.

## Интеграция с BI/ERP
- Для интеграции с BI/ERP реализован отдельный сервис/класс IntegrationService, который агрегирует данные из БД и RabbitMQ и передаёт их во внешние системы через REST API или ODBC.
- Все интеграции логируются и мониторятся на предмет ошибок и задержек. 
