# Итоговый ADR: Финальный выбор архитектуры и технологии обмена сообщениями

## Введение

Этот документ подводит итог архитектурного проектирования системы мониторинга скота для компании «АгроТех Х». На основании анализа, проведённого в Task1–Task3, здесь сравниваются архитектурные подходы и технологии обмена сообщениями, приводятся риски, компромиссы и делается финальный выбор.

---

## 1. Сравнение архитектурных подходов

### Агентская архитектура
- **Описание:** Локальные агенты на фермах, минимальная зависимость от центрального сервера, работа при отсутствии интернета.
- **Преимущества:** Простота развертывания, низкие требования к инфраструктуре, высокая устойчивость к сбоям связи, быстрый MVP.
- **Недостатки:** Ограниченная локальная обработка, сложная аналитика требует синхронизации с центральным сервером.
- **Риски:** Задержки при синхронизации, сложность интеграции с BI/ERP, возможные проблемы с масштабируемостью при росте числа ферм.

### Edge-вычислительная архитектура
- **Описание:** Мощные edge-вычислители на фермах, локальная обработка и хранение данных, периодическая синхронизация с центральным сервером.
- **Преимущества:** Независимость от центрального сервера, возможность сложной аналитики на месте, высокая масштабируемость.
- **Недостатки:** Высокая стоимость внедрения, сложность поддержки, избыточность для MVP.
- **Риски:** Требует больше ресурсов, сложнее обновлять и поддерживать, выше требования к персоналу.

#### Сводная таблица (архитектуры)
| Критерий                | Агентская архитектура | Edge-вычислительная архитектура |
|-------------------------|----------------------|-------------------------------|
| Масштабируемость        | Средняя              | Высокая                       |
| Стоимость внедрения     | Низкая               | Высокая                       |
| Устойчивость к сбоям    | Высокая              | Высокая                       |
| Локальная аналитика     | Ограничена           | Полная                        |
| Простота поддержки      | Высокая              | Средняя                       |
| Эволюция/масштабируемость| Средняя             | Высокая                       |
| Скорость MVP            | Высокая              | Средняя                       |

---

## 2. Сравнение технологий очередей сообщений

### RabbitMQ
- **Преимущества:** Простота эксплуатации, поддержка MQTT для IoT, подходит для MVP и небольших нагрузок, легко интегрируется, быстрое развертывание.
- **Недостатки:** Ограниченная масштабируемость, менее удобен для потоковой аналитики.
- **Риски:** При росте нагрузки потребуется миграция на более производительное решение.

### Kafka
- **Преимущества:** Высокая производительность и масштабируемость, поддержка потоковой обработки данных, хорошо подходит для событийно-ориентированной архитектуры.
- **Недостатки:** Сложнее в эксплуатации, требует больше ресурсов, не поддерживает MQTT "из коробки".
- **Риски:** Более высокие требования к инфраструктуре и квалификации команды.

#### Сводная таблица (очереди)
| Критерий                        | RabbitMQ                                      | Kafka                                         |
|----------------------------------|------------------------------------------------|-----------------------------------------------|
| Масштабируемость                | Хорошо для средних нагрузок                    | Отлично для высоких нагрузок                  |
| Надёжность доставки             | Гарантированная доставка (ack, retry, DLQ)     | Гарантированная доставка (commit log, replay) |
| Простота эксплуатации           | Прост в установке и поддержке                  | Сложнее в установке и поддержке               |
| Интеграция с IoT (MQTT)         | Прямая поддержка MQTT                          | Нет нативной поддержки MQTT                   |
| Потоковая аналитика             | Ограничена, требует внешних инструментов       | Встроенная (Kafka Streams, ksqlDB)            |
| Требования к инфраструктуре     | Минимальные                                    | Требует больше ресурсов                       |
| Отказоустойчивость, кластеризация| Поддерживается, но сложнее, чем у Kafka        | Встроенная, легко масштабируется              |
| Стоимость владения              | Ниже, проще DevOps, меньше ресурсов            | Выше, требует больше DevOps и ресурсов        |

---

## 3. Итоговый выбор и аргументация

### Архитектура
**Выбрана: Агентская архитектура**
- **Почему:**
  - Минимальные требования к инфраструктуре и персоналу.
  - Высокая устойчивость к сбоям связи (важно для ферм).
  - Быстрое развертывание MVP и простота поддержки.
  - Возможность эволюции в сторону edge-архитектуры при росте требований.
- **Почему не edge:**
  - Избыточна для MVP, требует больших инвестиций и ресурсов.
  - Сложнее поддерживать и обновлять на большом количестве ферм.

### Очередь сообщений
**Выбрана: RabbitMQ**
- **Почему:**
  - Простота эксплуатации и интеграции с IoT (MQTT).
  - Быстрое развертывание и низкий порог вхождения для команды.
  - Достаточно для MVP и начального масштабирования.
- **Почему не Kafka:**
  - Сложнее эксплуатация, выше требования к инфраструктуре.
  - Необходимость потоковой аналитики и экстремальной масштабируемости не критична для MVP.

### Компромиссы и риски
- **Компромисс:** выбранное решение — баланс между стоимостью, скоростью внедрения и возможностью дальнейшего развития системы.
- **Риски:** при росте нагрузки потребуется миграция на Kafka и/или эволюция архитектуры в сторону edge-вычислений.

---

## 4. Заключение

Выбранная архитектура (агентская) и технология очередей (RabbitMQ) обеспечивают оптимальный баланс между простотой, стоимостью, устойчивостью и возможностью развития. Это решение позволяет быстро запустить MVP, минимизировать риски и затраты, а при необходимости — масштабировать и эволюционировать систему. 